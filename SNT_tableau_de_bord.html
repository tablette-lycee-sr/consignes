<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="assets/styles/styleSNT_tableau_de_bord.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet" />

  <title>SNT - Tableau de bord</title>

  <!-- Inclusion de jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Inclusion de la bibliothèque PapaParse qui facilite l'analyse des fichiers CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>

<body>

  <h3>Tableau de bord SNT</h3>

  <!-- Div pour le décompte -->
  <div id="countdown" class="sticky"><span id="timer">5</span>"</div>

  <script>
    // URL du fichier CSV (tu peux le placer sur GitHub Pages, par exemple)
    const csvUrl = 'assets/donnees/eleves.csv'; // Remplace par le lien de ton fichier hébergé

    // Fonction pour lire et traiter le fichier CSV
    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        // Utiliser PapaParse pour analyser le CSV
        Papa.parse(csvText, {
          header: true, // Utilise la première ligne comme en-têtes
          complete: function (results) {
            // Les données extraites du CSV
            const eleves = results.data;

            // Boucle sur chaque élève pour créer les div dynamiquement
            eleves.forEach(eleve => {
              const nom = eleve.nom;
              const codeDweet = eleve.code_dweet;

              // Créer dynamiquement une div pour chaque élève
              const div = document.createElement('div');
              div.id = `live-data_${codeDweet}`;
              div.className = 'boite'; // Classe CSS pour le style de la boîte

              // Ajouter un titre avec le nom de l'élève
              div.innerHTML = `<h4>${nom}</h4>`;

              // Ajouter la div au tableau de bord
              document.querySelector('.cadre').appendChild(div);

              // Charger les données initiales et activer la mise à jour périodique
              fetchDweetData(codeDweet, div, nom);

              // Activer le polling à intervalle régulier (toutes les 5 secondes)
              setInterval(() => {
                // Démarrer le décompte
                let countdown = 5;
                const timerDisplay = document.getElementById('timer');

                // Mise à jour du décompte
                const countdownInterval = setInterval(() => {
                  timerDisplay.textContent = countdown;
                  countdown--;
                  if (countdown < 0) {
                    clearInterval(countdownInterval);
                    fetchDweetData(codeDweet, div, nom); // Mettre à jour les données
                    timerDisplay.textContent = '5'; // Réinitialiser le décompte pour la prochaine fois
                  }
                }, 1000); // Mettre à jour toutes les secondes
              }, 5000); // 5000 ms = 5 secondes
            });
          }
        });
      })
      .catch(error => {
        console.error('Erreur lors de la récupération du CSV :', error);
      });

    // Fonction pour récupérer les données de Dweet.io et mettre à jour la div
    function fetchDweetData(codeDweet, div, nom) {
      fetch(`https://dweet.io/get/latest/dweet/for/${codeDweet}`)
        .then(response => response.json())
        .then(data => {
          const dweet = data.with[0].content;
          const niveau = dweet.niveau;
          const humidite = dweet.humidite;

          // Insérer les données dans la div
          let html = `<h4 style="margin: 0;">${nom}</h4>`;
          html += `<div style="margin-top: auto;">`; // Aligne les données en bas
          html += `<p>Niveau: ${niveau}</p>`;
          // html += `<p>Humidité: ${humidite}</p>`;
          html += `</div>`;
          div.innerHTML = html; L = html;

          // Modifier la couleur en fonction du niveau
          updateDivStyle(div, niveau);
        })
        .catch(error => {
          console.error(`Erreur lors de la récupération des données pour ${nom} :`, error);
          div.innerHTML = `<h4>${nom}</h4><p>(Aucune donnée)</p>`; // Remplacer entièrement le contenu par le message d'erreur
          div.classList.remove('no-data','low-level', 'medium-level', 'high-level');
          div.classList.add('no-data');
        });
    }

    // Fonction pour mettre à jour la couleur du div en fonction du niveau
    function updateDivStyle(div, niveau) {
      div.classList.remove('no-data','low-level', 'medium-level', 'high-level');
      if (niveau < 1) {
        div.classList.add('low-level');
      } else if (niveau >= 1 && niveau < 3) {
        div.classList.add('medium-level');
      } else {
        div.classList.add('high-level');
      }
    }
  </script>

  <div class="cadre">
    <!-- Les div seront ajoutées ici dynamiquement -->
  </div>

</body>

</html>